# Cursor AI Rules for home-topology-ha

> Essential context for AI pair programming. For detailed patterns and examples, see `docs/cursor-guide.md`.

---

## Agentic Development Framework

**This project uses the Cursor Agentic Development Framework.**

Before starting any task:

0. **Load** `/docs/agent-quickstart.md` (fast startup context + command map)
1. **Load** `/project/README.md` - Master instruction set
2. **Check** `/project/epics/` - Current epic context
3. **Check** `/project/issues/` - Specific task details
4. **Follow** `/project/agent/*.md` - Task selection, dev, and review protocols

The framework provides structured workflows for task management, code generation, and self-review.

---

## Release Safety Rules (Mandatory)

1. Never cut, tag, or publish a release while any required build/check is failing.
2. Treat release as incomplete until required CI jobs and release workflow are green for the release commit.
3. When you discover and fix a recurring prerequisite (for example environment paths or tooling setup), you must:
   - automate it where feasible, and
   - document it in active workflow/runbook docs in the same change.

---

## 1. Project Identity

- **Name**: home-topology-ha
- **Purpose**: Home Assistant integration for the home-topology kernel
- **Core Library**: home-topology (platform-agnostic Python library)
- **Technology Stack**: Python 3.11+, TypeScript/Lit (frontend), Home Assistant APIs
- **Status**: v0.1.0-alpha (Initial development)

---

## 2. Architecture Principle

### Core Responsibility

This integration is a **thin adapter layer** between Home Assistant and the home-topology kernel.

**Integration Owns**: Translation, routing, exposure

- Platform → Kernel event translation
- Kernel → Platform entity exposure
- Timeout scheduling (coordinator pattern)
- Frontend panel & WebSocket API
- Configuration persistence

**Kernel Owns**: All behavior logic (from home-topology library)

- Location hierarchy (LocationManager)
- Event routing (EventBus)
- Module logic (Occupancy, Automation, Lighting)
- State management

### The Golden Rule

**The integration NEVER implements behavior logic. It translates, routes, and exposes. All logic lives in the kernel.**

---

## 3. Documentation Strategy

### 3-Tier Structure

Maintain a clean separation of concerns for documentation:

1.  **`project/`**: Agentic Framework for AI planning (Roadmap, Epics, Issues).
2.  **`docs/`**: Permanent technical reference (Architecture, Sync Contract, Coding Standards).
3.  **`docs/history/`**: Chronological archive for past summaries, milestone logs, and snapshots.

### Read Core Library Docs First

Before working on integration features:

- **Core Architecture**: `/workspaces/home-topology/docs/architecture.md`
- **Integration Guide**: `/workspaces/home-topology/docs/integration/integration-guide.md`
- **UI Design**: `/workspaces/home-topology/docs/integration/ui-design.md`

### Study Existing Home Assistant Integrations

**ALWAYS reference official HA integrations for patterns and best practices:**

- **Core Integrations**: https://github.com/home-assistant/core/tree/dev/homeassistant/components/
- **Study These First**:
  - `zha` - Complex coordinator pattern, entity management
  - `esphome` - Event translation, entity mapping
  - `mqtt` - WebSocket API, config flow patterns
  - `template` - Entity platform patterns
  - `lovelace` - Frontend panel registration

**When implementing a feature:**

1. Find similar feature in official integrations
2. Study their implementation patterns
3. Adapt to our architecture (thin adapter principle)
4. Follow their conventions (naming, error handling, logging)

### Local Documentation

- `docs/agent-quickstart.md` - required first-read startup context
- `docs/current-work.md` - live parallel-work and handoff context
- `docs/contracts.md` - canonical behavior and API/UI invariants
- `docs/cursor-guide.md` - Detailed patterns and examples (detailed version of this file)
- `docs/architecture.md` - Integration-specific architecture
- `docs/coding-standards.md` - Python + TypeScript standards
- `docs/frontend-dev-workflow.md` - Frontend development guide
- `docs/adr-log.md` - Architectural decisions
- `docs/work-tracking.md` - Project status

---

## 4. Coding Standards Summary

### Python (Backend)

- **Style**: PEP 8 via `ruff` and `black`
- **Naming**: `snake_case` for files/functions
- **Required**: Type hints on all functions
- **Async**: Use async/await for all I/O operations
- **Decorators**: Use `@callback` for sync event handlers

**Import Order**:

```python
from __future__ import annotations  # 1. Future
import logging                       # 2. Standard library
from homeassistant.core import ...  # 3. Home Assistant
from home_topology import ...        # 4. Kernel library
from .const import DOMAIN            # 5. Local integration
```

### TypeScript/Lit (Frontend)

> **See `.cursor/rules/` for detailed frontend AI context:**
>
> - `ha-components.mdc` - HA component reference (ha-form, ha-card, etc.)
> - `frontend-patterns.mdc` - Lit patterns, shouldUpdate, lifecycle
> - `styling.mdc` - CSS variables, theming, responsive design

**Core Rules:**

- **Framework**: Always use Lit (lit.dev). Never React, Vue, or Polymer.
- **Style**: Home Assistant Lit conventions
- **Naming**: `kebab-case` for component files
- **Components**: Use existing `ha-*` components where possible
- **Required**: TypeScript strict mode
- **Pattern**: LitElement with `@customElement` decorator
- **Styling**: Use CSS variables from HA theme system, never hardcoded hex colors
- **Forms**: Prefer `ha-form` with schema over manual form building

**Critical Pattern - hass Reactivity:**

```typescript
// ALWAYS use attribute: false for hass (it's a complex object)
@property({ attribute: false }) public hass!: HomeAssistant;

// ALWAYS implement shouldUpdate to filter unnecessary re-renders
protected shouldUpdate(changedProps: PropertyValues): boolean {
  if (changedProps.has('_localState')) return true;
  if (changedProps.has('hass')) {
    const oldHass = changedProps.get('hass');
    // Only re-render if relevant data changed
    return oldHass?.areas !== this.hass.areas;
  }
  return true;
}
```

**Development Workflow:**

```bash
cd custom_components/topomation/frontend
npm run dev                    # Start Vite with HMR
# Open http://localhost:5173/mock-harness.html
```

---

## 5. Common Pitfalls

### ❌ DON'T

- Implement behavior logic in the integration (use kernel modules)
- Block the event loop (use async for I/O)
- Create HA dependencies in core library imports
- Use `time.sleep()` or blocking calls
- Mutate HA state objects directly
- Forget to handle missing entities/locations gracefully
- Use hardcoded hex colors in CSS (breaks theming)
- Build custom forms when `ha-form` with schema works
- Skip `shouldUpdate` filtering (causes 100+ re-renders/minute)

### ✅ DO

- Translate events, don't process them
- Use `@callback` for synchronous event handlers
- Use `async_track_point_in_time()` for scheduling
- Validate all user inputs
- Handle errors gracefully (one bad location shouldn't crash)
- Log liberally with appropriate levels
- Use HA CSS variables for all colors
- Use `ha-form` schemas for configuration UIs
- Filter `hass` updates in `shouldUpdate`

---

## 6. Key Integration Concepts

### Event Translation

- **Platform → Kernel** (`event_bridge.py`): HA `state_changed` → `Event(type="...")`
- **Kernel → Platform** (`binary_sensor.py`): `occupancy.changed` → Update entity

### Timeout Coordination

The kernel is time-agnostic. Integration schedules timeout checks via `HomeTopologyCoordinator`.

### Location Type Metadata

The kernel is type-agnostic. Store type/icon metadata via `_meta` module config.

**See `docs/cursor-guide.md` for code examples and detailed patterns.**

---

## 7. File Organization

```
home-topology-ha/
├── project/                 # Agentic Development Framework
│   ├── README.md            # Master instruction set
│   ├── roadmap.md           # High-level timeline
│   ├── epics/               # Feature-level tracking
│   ├── issues/              # Task-level tracking
│   └── agent/               # AI behavior protocols
├── .cursor/rules/           # Granular AI context rules
│   ├── ha-components.mdc    # HA web components reference
│   ├── frontend-patterns.mdc # Lit patterns & lifecycle
│   └── styling.mdc          # CSS theming rules
├── custom_components/topomation/
│   ├── __init__.py          # Integration setup
│   ├── config_flow.py       # Setup wizard
│   ├── coordinator.py       # Timeout scheduling
│   ├── event_bridge.py      # HA → kernel events
│   ├── binary_sensor.py     # Occupancy entities
│   ├── websocket_api.py     # WS API handlers
│   └── frontend/            # Lit components (kebab-case)
│       ├── mock-harness.html # Dev harness
│       ├── mock-hass.ts     # Mock hass factory
│       ├── topomation-panel.ts
│       └── ...components
├── docs/
│   ├── cursor-guide.md      # Detailed patterns & examples
│   ├── frontend-dev-workflow.md # Frontend development guide
│   ├── architecture.md
│   ├── coding-standards.md
│   └── work-tracking.md
├── tests/
└── .cursorrules             # This file
```

---

## 8. Golden Rules

1. **ALWAYS study existing HA integrations before implementing features**
2. **ALWAYS read core library docs before implementing features**
3. **Integration translates, kernel implements**
4. **Use async/await for all I/O operations**
5. **Type hints are mandatory**
6. **Log errors, don't crash**
7. **Test event translation thoroughly**
8. **Use real current dates; do not hardcode year assumptions** ⚠️
9. **Update `docs/work-tracking.md` as you work**
10. **Reference existing code, don't duplicate patterns**
11. **Leverage HA's components and conventions, don't reinvent**
12. **Frontend: Use ha-form schemas, CSS variables, shouldUpdate filtering**
13. **Documentation: No underscores in filenames; use hyphens and YYYY.MM.DD prefix for history** [[memory:8853163]]
14. **Artifact Management: Archive transient summaries to `docs/history/`; don't clutter root**

---

## 9. Artifact Bloat Prevention

To maintain a high-signal workspace, follow these document management rules:

- **No Root Summaries**: Never create completion summaries or status reports in the project root.
- **Archive by Default**: Move milestone completion logs, phase summaries, and transient reports to `docs/history/` immediately after the task is finished.
- **Naming Standard**: Use `YYYY.MM.DD-description.md` for historical artifacts.
- **Consolidate Status**: Use `docs/work-tracking.md` as the single source of truth for daily progress. Avoid creating separate "status" files.
- **Hyphens Only**: Never use underscores in file or directory names. Use hyphens for readability.

---

## Quick Reference

| Task               | Read First                                          |
| ------------------ | --------------------------------------------------- |
| Event translation  | Core: integration-guide.md, Local: cursor-guide.md  |
| State exposure     | Core: integration-guide.md, HA: binary_sensor.py    |
| Timeout scheduling | Core: integration-guide.md, HA: coordinator.py      |
| UI components      | `.cursor/rules/ha-components.mdc`, `docs/frontend-dev-workflow.md`, `docs/index.md` |
| WebSocket API      | Local: cursor-guide.md, HA: websocket_api.py        |
| Location types     | Core: integration-guide.md (Location Types section) |
| Frontend workflow  | `docs/frontend-dev-workflow.md`                     |
| Lit patterns       | `.cursor/rules/frontend-patterns.mdc`               |
| CSS theming        | `.cursor/rules/styling.mdc`                         |

---

**This integration is a bridge, not a duplicate. The kernel does the work; we just wire it up.**

For detailed code examples, patterns, and testing strategies, see `docs/cursor-guide.md`.

Last Updated: 2025-12-25
