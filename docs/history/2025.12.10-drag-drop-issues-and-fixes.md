# Drag-and-Drop Issues and Design Decisions

**Date**: 2025-12-10
**Status**: Issues Identified, Fixes In Progress

## Issues Identified

### 1. Root "House" Location - Design Question

**User Question**: Do we need the root "House"? In HA, the root could be:

- The HA installation name
- All floors are root-level (no container)

**Current Design**:

- Architecture supports both patterns:
  - `is_explicit_root=True`: Intentional root (like "House", "Garage")
  - Floors can be root-level OR under a "House"
- Mock data includes "House" as a container, but this is just for demo

**Decision Needed**:

- Should we make "House" optional?
- Should floors default to root-level?
- Should UI allow both patterns?

**Recommendation**: Make it flexible - allow floors to be root-level OR under a container. User chooses during setup.

### 2. "Unassigned Room" - What Is It?

**Answer**:

- Location with `parent_id=null` AND `is_explicit_root=false`
- These are discovered from HA areas but not yet organized
- Should appear in an "Unassigned" section (Inbox pattern)
- Currently mixed with root locations in tree

**Fix Needed**: Separate unassigned locations into their own section in the UI.

### 3. Drag Handle Click Issue

**Problem**: Clicking drag handle selects the tree node instead of starting drag.

**Root Cause**: The `@click` handler on `.tree-node` catches all clicks, including drag handle.

**Fix**:

- Add `@mousedown` handler to drag handle that stops propagation
- Ensure SortableJS handles drag start correctly
- Prevent click selection when drag is active

### 4. Cannot Move Unassigned Room to Floor

**Problem**: Drag-and-drop only handles reordering within same parent, not reparenting.

**Root Cause**: `_handleDragEnd` always sets `newParentId = null` (root level only).

**Fix Needed**:

- Detect drop target (which parent node was dropped onto)
- Calculate new parent based on drop position
- Handle moving from unassigned → floor
- Handle moving from floor → floor (reparenting)

### 5. Cannot Create Child Locations via Drag

**Problem**: Can't drag a location onto a parent to make it a child.

**Root Cause**: SortableJS is configured on flat list, not handling nested drop targets.

**Fix Needed**:

- Configure SortableJS to handle nested groups
- Detect when dropping onto a parent node
- Set `newParentId` to the parent's ID
- Handle hierarchy validation (per ui-design.md 5.3.1)

### 6. Incomplete Testing

**Issues**:

- Didn't test reparenting scenarios
- Didn't test moving unassigned items
- Didn't test drag handle click behavior
- Didn't test nested drag-and-drop

**Why**:

- Implemented basic SortableJS integration
- Assumed it would "just work" without testing actual use cases
- Didn't follow design guide's drag-and-drop requirements fully

## Required Fixes

### Priority 1: Fix Drag Handle Click

- Prevent tree node selection when clicking drag handle
- Ensure drag starts correctly

### Priority 2: Implement Reparenting

- Detect drop target parent
- Calculate new parent_id based on drop position
- Handle moving unassigned → assigned
- Handle moving between parents

### Priority 3: Separate Unassigned Section

- Show unassigned locations in separate "Unassigned" section
- Allow dragging from unassigned to assigned locations

### Priority 4: Hierarchy Validation

- Implement validation per ui-design.md 5.3.1
- Block invalid moves (e.g., Room → Floor)
- Show visual feedback (green=valid, red=invalid)

### Priority 5: Nested Drag-and-Drop

- Configure SortableJS for nested groups
- Allow dropping onto parent nodes to create children

## Design Guide Gaps

**Missing from ui-design.md**:

1. How to handle unassigned locations in tree view
2. Detailed drag-and-drop implementation (nested groups)
3. Reparenting logic specification
4. Root location patterns (optional vs required)

**Should Add**:

- Section on unassigned locations display
- Detailed drag-and-drop implementation guide
- Reparenting algorithm specification
- Root location design patterns
