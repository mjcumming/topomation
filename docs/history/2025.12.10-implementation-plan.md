# Home Topology UI Implementation Plan

**Date**: 2025-12-10
**Status**: In Progress
**Based on**: `docs/ui-design.md` v0.2

## Overview

Complete implementation of the Home Topology Location Manager UI according to the design specification. All functionality must work in both light and dark themes.

## Tasks

### Phase 1: Fix Current Issues (Priority: Critical)

1. **Remove Duplicate "New Location" Button**

   - Keep only one button in header (per ui-design.md 3.1.1)
   - Remove button from tree component
   - Ensure button opens location dialog

2. **Fix Button Functionality**

   - "New Location" ‚Üí Opens `ht-location-dialog` with empty form
   - "Add Test Location" ‚Üí Creates test location via mock API
   - "Add Source" ‚Üí Opens `ht-add-device-dialog`
   - All buttons must be visible in both themes

3. **Fix Theme Visibility**
   - Ensure all text, buttons, icons visible in light AND dark
   - Use explicit CSS variables with fallbacks
   - Test both themes before marking complete

### Phase 2: Core Location Manager Functions

4. **Create Location**

   - Dialog opens from "New Location" button
   - Form: name, type, parent selection
   - Calls `home_topology/locations/create` WebSocket API
   - Updates tree immediately

5. **Delete Location**

   - Delete button (üóëÔ∏è) visible on hover
   - Confirmation dialog
   - Calls `home_topology/locations/delete` API
   - Removes from tree, clears selection if deleted

6. **Inline Rename**
   - Double-click location name ‚Üí inline edit
   - Enter or blur ‚Üí saves via `home_topology/locations/update`
   - Escape ‚Üí cancels edit

### Phase 3: Drag-and-Drop

7. **Implement SortableJS**

   - Install/import SortableJS
   - Add drag handle (6-dot grip) visible on hover
   - Configure SortableJS on tree container
   - Handle drag end ‚Üí calculate new parent/index
   - Call `home_topology/locations/reorder` API

8. **Hierarchy Validation**
   - Validate moves per ui-design.md 5.3.1
   - Show visual feedback (green=valid, red=invalid)
   - Block illegal moves (e.g., Room ‚Üí Floor)
   - Prevent cycles (can't move into own child)

### Phase 4: Polish

9. **Status Indicators**

   - Occupancy state dots (green=occupied, gray=vacant)
   - Pending changes spark (‚ú¶)
   - Selected state highlight

10. **Keyboard Navigation**
    - Arrow keys for tree navigation
    - Enter to activate
    - Delete to remove (with confirmation)

## Implementation Order

1. Fix duplicate button (5 min)
2. Fix button functionality (10 min)
3. Fix theme visibility (10 min)
4. Implement create/delete (20 min)
5. Implement inline rename (15 min)
6. Implement drag-and-drop (30 min)
7. Add hierarchy validation (20 min)
8. Test everything (15 min)

**Total Estimated Time**: ~2 hours

## Acceptance Criteria

- [ ] Only ONE "New Location" button (in header)
- [ ] All buttons work and are visible in both themes
- [ ] Can create new locations via dialog
- [ ] Can delete locations with confirmation
- [ ] Can rename locations inline (double-click)
- [ ] Can drag-and-drop to reorder/reparent
- [ ] Invalid moves are blocked with visual feedback
- [ ] Tree expands/collapses correctly
- [ ] All location manager functions work end-to-end

## Notes

- Follow ui-design.md exactly for layout and behavior
- Use HA components where specified (ha-dialog, ha-form, etc.)
- All API calls via `hass.callWS()`
- Mock harness must support all operations for testing
